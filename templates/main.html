<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.css">
        <link rel="stylesheet" href="/static/styles.css">
        <link rel="stylesheet" href="/static/dice.css">

        <style>
            .box-style
            {             
                border-radius: 25px;
                padding: 5px 30px 10px 30px;
            }

            .flexboxrow
            {
                display: flex;
                height: 40%;
                align-items: stretch;
                justify-content: center;
            }
            .flexboxrow > div 
            {
                width: 40%;
                margin: 10px;
            }

            .flexboxcol
            {
                display: flex;
                height: 150%;
                flex-direction: column;
            }
            .flexboxcol > div 
            {
                width: 170%;
                transform: translate(-20%, 0%);
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <div class="flexboxcol">
            <a href="/">
                <div class="nav-bar">
                    <h1> D&D GM Board </h1>
                </div>
            </a>

            <div class="flexboxrow">
                
                <div class="characters page box-style">
                    <h2>Characters</h2>
                    {% for player in players %}
                        <p value="{{ player.id }}">{{ player.name }}</p>
                        <ul>
                            <li>
                                HP: {{player.current_health}}/{{player.max_health}}
                            </li>
                            <li>
                                <table>
                                    <tr>
                                        <th>Strength</th>
                                        <th>Dexterity</th>
                                        <th>Const.</th>
                                        <th>Intell.</th>
                                        <th>Wisdom</th>
                                        <th>Charisma</th>
                                    </tr>
                                    <tr>
                                        {% for ability in player.abilities %} 
                                        <td>{{ability}}</td>
                                        {% endfor %}
                                    </tr>
                                </table>
                            </li>
                        </ul>
                    {% endfor %}

                </div>
                <div class="monsters page box-style">
                    <h2>Monsters</h2>
                    <label for="challenge">Challenge rating: </label>
                    <input type="number" name="challenge" id="challenge" style="width:15%;">

                    <a id="searchMonsterLink" href="#">
                    <button style="position: absolute; top: 100px; left: 30%;"> 
                            Search 
                    </button>
                    </a>

                    <label for="monster-select" style="position: absolute; top: 75px; left: 55%;">List of monsters with that level: </label>
                    <select style="position: absolute; top: 100px; left: 55%;"
                            id="monster-select"
                            onchange="fetchMonsterDetails(this.value)">
                        <option>Select one</option>
                        {% for monster in monsters %}
                        <option value="{{ monster.index }}">{{ monster.name }}</option>
                        {% endfor %}
                    </select>

                    <h2> Monster details </h2>
                    <p id="type">Species: </p>
                    <p id="alignment">Alignment: </p>

                    <p id="monster-hp">HP: </p>
                    <p id="monster-dice">Attack: </p>

                    <table>
                        <tr>
                            <th>Strength</th>
                            <th>Dexterity</th>
                            <th>Const.</th>
                            <th>Intell.</th>
                            <th>Wisdom</th>
                            <th>Charisma</th>
                        </tr>
                        <tr>
                            <td id="str"></td>
                            <td id="dex"></td>
                            <td id="con"></td>
                            <td id="int"></td>
                            <td id="wis"></td>
                            <td id="cha"></td>
                        </tr>
                    </table>

                    <button id="add-monster-button" onclick="addMonster()">
                        Add monster
                    </button>

                </div>
            </div>

            <div class="" style="">
                <div class="page box-style">
                    <h2>Current interaction</h2>

                    <h3>Monsters to beat</h3>

                    <div id="current-monsters"></div>
                </div>
            </div>
            <div class="" style="">
                <div class="page box-style">
                    <h2>In case you forgot your dice</h2>
                    
                        <!-- Dice options displayed in a row with labels above the dice -->
                        <div class="diceContainer">
                            <div>
                                <div class="diceLabel">D4</div>
                                <div class="diceResult d4" id="resultD4" data-sides="4">?
                                    <div class="line line-d4vert"></div>
                                </div>
                            </div>
                            <div>
                                <div class="diceLabel">D6</div>
                                <div class="diceResult d6" id="resultD6" data-sides="6">?</div>
                            </div>
                            <div>
                                <div class="diceLabel">D8</div>
                                <div class="diceResult d8" id="resultD8" data-sides="8">?</div>
                            </div>
                            <div>
                                <div class="diceLabel">D10</div>
                                <div class="diceResult d10" id="resultD10" data-sides="10">?</div>
                            </div>
                            <div>
                                <div class="diceLabel">D12</div>
                                <div class="diceResult d12" id="resultD12" data-sides="12">?</div>
                            </div>
                            <div>
                                <div class="diceLabel">D20</div>
                                <div class="diceResult d20" id="resultD20" data-sides="20">?</div>
                            </div>
                        </div>
                    

                </div>
            </div>
        </div>
    </body>
</html>


<script src="/static/dice.js"></script>
<script>
// Get the necessary elements
const challengeInput = document.getElementById('challenge');
const searchMonsterLink = document.getElementById('searchMonsterLink');

// Event listener to update the href when input changes
challengeInput.addEventListener('input', () => {
    const challengeValue = challengeInput.value; // Get the input value
    const game_id = "{{game.game_id}}"; // Use the existing game name
    searchMonsterLink.href = `/STARTGAME?game_id=${game_id}&challenge_index=${challengeValue}`;
});
</script>

<script>
async function fetchMonsterDetails(monsterIndex) {
    if (!monsterIndex) return; // Do nothing if no monster is selected

    try {
        // Replace with your API endpoint
        const response = await fetch(`https://www.dnd5eapi.co/api/monsters/${monsterIndex}`);
        if (!response.ok) throw new Error("Failed to fetch monster details.");

        const data = await response.json();

        // Update the page with monster details
        document.getElementById("type").textContent = `Species: ${data.type}`;
        document.getElementById("alignment").textContent = `Alignment: ${data.alignment}`;

        document.getElementById("monster-hp").textContent = `HP: ${data.hit_points}`;
        document.getElementById("monster-dice").textContent = `Attack: ${data.hit_points_roll}`;

        document.getElementById("str").textContent = `${data.strength}`;
        document.getElementById("dex").textContent = `${data.dexterity}`;
        document.getElementById("con").textContent = `${data.constitution}`;
        document.getElementById("int").textContent = `${data.intelligence}`;
        document.getElementById("wis").textContent = `${data.wisdom}`;
        document.getElementById("cha").textContent = `${data.charisma}`;
    } catch (error) {
        console.error("Error fetching monster details:", error);
    }
}

monsterList = [];
monsterNamesList = [];
monsterMaxHPList = [];
monsterHPList = [];
monsterAttacksList = [];

itemList = [];

// add a monster to the current interaction
async function addMonster() 
{
    monster_index = document.getElementById("monster-select").value;
    if (!monster_index) return; // Do nothing if no monster is selected

    try {
        // Update the page with monster details
        monsterList.push(monster_index);

        const response = await fetch(`https://www.dnd5eapi.co/api/monsters/${monster_index}`);
        if (!response.ok) throw new Error("Failed to fetch monster details.");

        const data = await response.json();

        monsterNamesList.push(data.name);

        monsterHPList.push(data.hit_points);
        monsterMaxHPList.push(data.hit_points);

        monsterAttacksList.push(data.actions);

        displayMonsterList();
    } catch (error) {
        console.error("Error fetching monster details:", error);
    }
}

// remove monster from current interaction
function removeMonster(monster_id) {
    // Find the index of the player in the array
    const index = monsterList.indexOf( monster_id );
    
    if (index !== -1) {
        // Remove the player from the array
        monsterList.splice( index, 1 );
        monsterNamesList.splice( index, 1 );
        monsterMaxHPList.splice( index, 1 );
        monsterHPList.splice( index, 1 );
        monsterAttacksList.splice( index, 1 );

        displayMonsterList();
    }
}

// display the monsters in current interaction
async function displayMonsterList()
{
    const currentMonsters = document.querySelector('#current-monsters');
    currentMonsters.innerHTML = "";

    // Loop through the playerList and create a <li> for each item
    monsterList.forEach( async item => {
        const index = monsterList.indexOf( item );

        const li = document.createElement("li");


        // Create a "Remove monster" button
        const removeButton = document.createElement("button");
        removeButton.setAttribute("type", "button")
        removeButton.setAttribute("style", "margin: 5px 0px 5px 50px;")
        removeButton.textContent = "Remove";
        removeButton.onclick = function () {
            removeMonster( item );
        };


        // Add the item text to the <li>
        li.textContent = monsterNamesList[index] + ", HP: " + monsterHPList[index] + "/" + monsterMaxHPList[index];


        // Create and append the attack buttons
        for (const attack of monsterAttacksList[index])
        {
            // Create a "Attack player" button
            const attackButton = document.createElement("button");
            attackButton.setAttribute("type", "button")
            attackButton.setAttribute("style", "margin: 0px 0px 0px 10px;")
            attackButton.textContent = attack.name;
            attackButton.onclick = function () {
                attackplayer( int( attack.damage[0].damage_dice ) );
            };

            // Append the remove button to the <li>
            li.appendChild(attackButton);
        }


        // Append the remove button to the <li>
        li.appendChild(removeButton);

        // Append the <li> to the list container
        currentMonsters.appendChild(li);
    });
}
</script>